---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import XingsiCard from "@/components/XingsiCard.astro";
// import { SITE } from "@/config";

// å¯¼å…¥è¡Œæ€å½•æ•°æ®
import xingsiData from "@/data/xingsi.json";
import type { XingsiRecord } from "@/types/xingsi";

// ç±»å‹è½¬æ¢å’Œæ•°æ®å¤„ç†
const records: XingsiRecord[] = xingsiData as XingsiRecord[];

// æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
const sortedRecords = records.sort((a, b) => {
  return new Date(b.datetime).getTime() - new Date(a.datetime).getTime();
});

// è·å–ç»Ÿè®¡ä¿¡æ¯
const totalRecords = records.length;
const dateRange = {
  start: new Date(Math.min(...records.map(r => new Date(r.datetime).getTime()))),
  end: new Date(Math.max(...records.map(r => new Date(r.datetime).getTime())))
};

// ä¸»é¢˜ç»Ÿè®¡
const themeStats = records.reduce((acc, record) => {
  const theme = record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.æœ¬å‘¨ä¸»é¢˜;
  acc[theme] = (acc[theme] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const topThemes = Object.entries(themeStats)
  .sort(([,a], [,b]) => b - a)
  .slice(0, 5);

// æ„Ÿå—ç»Ÿè®¡
const feelingStats = records.reduce((acc, record) => {
  const feelings = record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ„Ÿå—.split(/[ã€ï¼Œ,]/).map(f => f.trim()).filter(f => f);
  feelings.forEach(feeling => {
    acc[feeling] = (acc[feeling] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

const topFeelings = Object.entries(feelingStats)
  .sort(([,a], [,b]) => b - a)
  .slice(0, 8);
---

<Layout 
  title="è¡Œæ€å½• | Cihebi's Blog"
  description="ä¸ªäººæˆé•¿ä¸åæ€è®°å½•ï¼Œè®°å½•æ¯æ—¥çš„æ€è€ƒã€æ„Ÿå—å’Œæ´å¯Ÿ"
>
  <Header />
  
  <main id="main-content">
    <div class="container">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <div class="page-header">
        <div class="title-section">
          <h1 class="page-title">ğŸ“” è¡Œæ€å½•</h1>
          <p class="page-description">
            è®°å½•æ—¥å¸¸æ€è€ƒä¸æ„Ÿæ‚Ÿï¼Œè¿½è¸ªä¸ªäººæˆé•¿è½¨è¿¹ã€‚è¿™é‡Œæ˜¯æˆ‘çš„åæ€ç©ºé—´ï¼Œè®°å½•ç€æ¯å¤©çš„å®éªŒã€æ´å¯Ÿå’Œè®¡åˆ’ã€‚
          </p>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number">{totalRecords}</div>
            <div class="stat-label">è®°å½•æ€»æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{Math.ceil((dateRange.end.getTime() - dateRange.start.getTime()) / (1000 * 60 * 60 * 24))}</div>
            <div class="stat-label">è®°å½•å¤©æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{Object.keys(themeStats).length}</div>
            <div class="stat-label">ä¸»é¢˜æ•°é‡</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{records.filter(r => r.image_url).length}</div>
            <div class="stat-label">æœ‰å›¾è®°å½•</div>
          </div>
        </div>
      </div>

      <!-- ä¸»é¢˜å’Œæ„Ÿå—æ ‡ç­¾äº‘ -->
      <div class="insights-overview">
        <div class="insight-section">
          <h3>ğŸ¯ ä¸»è¦ä¸»é¢˜</h3>
          <div class="tag-cloud">
            {topThemes.map(([theme, count]) => (
              <span class="theme-tag" style={`font-size: ${Math.min(1.2, 0.8 + count * 0.1)}rem`}>
                {theme} ({count})
              </span>
            ))}
          </div>
        </div>
        
        <div class="insight-section">
          <h3>ğŸ’­ æƒ…æ„Ÿè®°å½•</h3>
          <div class="tag-cloud">
            {topFeelings.map(([feeling, count]) => (
              <span class="feeling-tag" style={`font-size: ${Math.min(1.1, 0.75 + count * 0.05)}rem`}>
                {feeling} ({count})
              </span>
            ))}
          </div>
        </div>
      </div>

      <!-- è®°å½•åˆ—è¡¨ -->
      <div class="records-section">
        <h2 class="section-title">ğŸ“‹ è®°å½•æ—¶å…‰</h2>
        <div class="records-grid">
          {sortedRecords.map((record) => (
            <XingsiCard record={record} />
          ))}
        </div>
      </div>
    </div>
  </main>
  
  <Footer />
</Layout>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .page-header {
    margin: 40px 0 60px 0;
    text-align: center;
  }

  .title-section {
    margin-bottom: 40px;
  }

  .page-title {
    font-size: 3rem;
    font-weight: 700;
    color: rgb(var(--color-text-base));
    margin: 0 0 16px 0;
    background: linear-gradient(135deg, rgb(var(--color-accent)), rgb(var(--color-accent)) 70%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .page-description {
    font-size: 1.125rem;
    color: rgb(var(--color-text-muted));
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 24px;
    max-width: 800px;
    margin: 0 auto;
  }

  .stat-item {
    background: var(--color-card-muted);
    padding: 24px 16px;
    border-radius: 16px;
    text-align: center;
    border: 1px solid rgba(var(--color-border), 0.1);
    transition: transform 0.2s ease;
  }

  .stat-item:hover {
    transform: translateY(-2px);
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: rgb(var(--color-accent));
    margin-bottom: 8px;
  }

  .stat-label {
    font-size: 0.875rem;
    color: rgb(var(--color-text-muted));
    font-weight: 500;
  }

  .insights-overview {
    margin-bottom: 60px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
  }

  .insight-section {
    background: var(--color-card-muted);
    padding: 24px;
    border-radius: 16px;
    border: 1px solid rgba(var(--color-border), 0.1);
  }

  .insight-section h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: rgb(var(--color-text-base));
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .theme-tag, .feeling-tag {
    background: rgba(var(--color-accent), 0.1);
    color: rgb(var(--color-accent));
    padding: 4px 12px;
    border-radius: 16px;
    font-weight: 500;
    transition: all 0.2s ease;
    cursor: default;
  }

  .feeling-tag {
    background: rgba(var(--color-text-muted), 0.1);
    color: rgb(var(--color-text-muted));
  }

  .theme-tag:hover, .feeling-tag:hover {
    transform: scale(1.05);
    opacity: 0.8;
  }

  .records-section {
    margin-bottom: 60px;
  }

  .section-title {
    font-size: 2rem;
    font-weight: 600;
    color: rgb(var(--color-text-base));
    margin: 0 0 32px 0;
    text-align: center;
  }

  .records-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr;
  }

  @media (min-width: 640px) {
    .records-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .records-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1280px) {
    .records-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .container {
      padding: 0 16px;
    }

    .page-title {
      font-size: 2.5rem;
    }

    .page-description {
      font-size: 1rem;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .stat-item {
      padding: 16px 12px;
    }

    .stat-number {
      font-size: 1.5rem;
    }

    .insights-overview {
      grid-template-columns: 1fr;
      gap: 24px;
      margin-bottom: 40px;
    }

    .insight-section {
      padding: 20px;
    }

    .section-title {
      font-size: 1.75rem;
    }
  }

  @media (max-width: 480px) {
    .page-title {
      font-size: 2rem;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .tag-cloud {
      justify-content: center;
    }
  }
</style>