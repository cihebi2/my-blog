---
import type { XingsiRecord } from "@/types/xingsi";

export interface Props {
  record: XingsiRecord;
}

const { record } = Astro.props;

// è§£ææ—¥æœŸ
const date = new Date(record.datetime);
const formattedDate = date.toLocaleDateString('zh-CN', {
  month: 'long',
  day: 'numeric'
});
const formattedTime = date.toLocaleTimeString('zh-CN', {
  hour: '2-digit',
  minute: '2-digit'
});

// æå–ä»Šæ—¥å°è®¡çš„æ‘˜è¦ï¼ˆå‰80å­—ç¬¦ï¼‰
const getSummary = (text: string) => {
  const cleanText = text.replace(/\*\*/g, '').replace(/\n+/g, ' ').trim();
  return cleanText.length > 80 ? cleanText.substring(0, 80) + '...' : cleanText;
};

// è·å–ä¸»é¢˜è‰²è°ƒ
const getThemeColor = (theme: string) => {
  const themes: Record<string, string> = {
    'ç²¾åŠ›èŠ‚å¾‹ä¼˜åŒ–': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
    'æƒ…ç»ªç®¡ç†': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300', 
    'æ—¶é—´ç®¡ç†': 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
    'å­¦ä¹ æ•ˆç‡': 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
    'äººé™…å…³ç³»': 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300',
    'å¥åº·ç®¡ç†': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300'
  };
  return themes[theme] || 'bg-gray-100 text-gray-700 dark:bg-gray-900/30 dark:text-gray-300';
};

// è·å–å¿ƒæƒ…å›¾æ ‡
const getMoodIcon = (feeling: string) => {
  if (feeling.includes('å¹³é™') || feeling.includes('è‡ªåœ¨')) return 'ğŸ˜Œ';
  if (feeling.includes('ç–²æƒ«') || feeling.includes('ç´¯')) return 'ğŸ˜´';
  if (feeling.includes('å¤±æœ›') || feeling.includes('æ²®ä¸§')) return 'ğŸ˜';
  if (feeling.includes('ç„¦è™‘') || feeling.includes('çƒ¦èº')) return 'ğŸ˜°';
  if (feeling.includes('æ»¡è¶³') || feeling.includes('å¼€å¿ƒ')) return 'ğŸ˜Š';
  if (feeling.includes('å›°æƒ‘') || feeling.includes('è¿·èŒ«')) return 'ğŸ¤”';
  return 'ğŸ™‚';
};

// ç”Ÿæˆå”¯ä¸€ID
const cardId = `card-${record.datetime.replace(/[^0-9]/g, '')}`;
---

<article class="xingsi-card" data-id={cardId}>
  <!-- å¡ç‰‡å¤´éƒ¨ -->
  <header class="card-header">
    <div class="date-section">
      <time class="date-text">{formattedDate}</time>
      <span class="time-text">{formattedTime}</span>
    </div>
    <div class="mood-section">
      <span class="mood-icon">{getMoodIcon(record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ„Ÿå—)}</span>
    </div>
  </header>

  <!-- ä¸»é¢˜æ ‡ç­¾ -->
  {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.æœ¬å‘¨ä¸»é¢˜ && (
    <div class="theme-row">
      <span class={`theme-tag ${getThemeColor(record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.æœ¬å‘¨ä¸»é¢˜)}`}>
        {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.æœ¬å‘¨ä¸»é¢˜}
      </span>
    </div>
  )}

  <!-- å†…å®¹é¢„è§ˆ -->
  <div class="content-preview">
    <p class="summary-text">
      {getSummary(record.ä»Šæ—¥å°è®¡)}
    </p>
    
    {record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ && (
      <div class="insight-preview">
        <span class="insight-label">ğŸ’¡</span>
        <span class="insight-text">
          {record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ.length > 60 
            ? record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ.substring(0, 60) + '...'
            : record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ
          }
        </span>
      </div>
    )}
  </div>

  <!-- ç‚¹å‡»å±•å¼€æŒ‰é’® -->
  <button class="expand-button" onclick={`toggleDetail('${cardId}')`}>
    <span class="expand-text">æŸ¥çœ‹è¯¦æƒ…</span>
    <span class="expand-icon">â–¼</span>
  </button>
</article>

<!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id={`detail-${cardId}`} class="detail-modal hidden">
  <div class="modal-overlay" onclick={`toggleDetail('${cardId}')`}></div>
  <div class="modal-content">
    <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
    <header class="modal-header">
      <div>
        <h2 class="modal-title">è¡Œæ€å½•è¯¦æƒ…</h2>
        <p class="modal-date">{formattedDate} {formattedTime}</p>
      </div>
      <button class="close-btn" onclick={`toggleDetail('${cardId}')`}>âœ•</button>
    </header>

    <!-- æ¨¡æ€æ¡†å†…å®¹ -->
    <div class="modal-body">
      <!-- ä»Šæ—¥å°è®¡ -->
      <section class="detail-section">
        <h3 class="section-title">ğŸ“ ä»Šæ—¥å°è®¡</h3>
        <div class="section-content">
          <p class="text-content">{record.ä»Šæ—¥å°è®¡.replace(/\*\*/g, '').replace(/\n/g, '<br>')}</p>
        </div>
      </section>

      <!-- ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜ -->
      {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.title && (
        <section class="detail-section">
          <h3 class="section-title">ğŸ”„ ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜</h3>
          <div class="section-content">
            <h4 class="subsection-title">"{record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.title}"</h4>
            <div class="details-grid">
              <div class="detail-item">
                <strong>æœ¬å‘¨ä¸»é¢˜ï¼š</strong>
                <span>{record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.æœ¬å‘¨ä¸»é¢˜}</span>
              </div>
              {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.ä»Šæ—¥å®éªŒ && (
                <div class="detail-item">
                  <strong>ä»Šæ—¥å®éªŒï¼š</strong>
                  <span>{record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.ä»Šæ—¥å®éªŒ}</span>
                </div>
              )}
              {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.è¡ŒåŠ¨ä¸è§‚å¯Ÿ && (
                <div class="detail-item">
                  <strong>è¡ŒåŠ¨ä¸è§‚å¯Ÿï¼š</strong>
                  <span>{record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.è¡ŒåŠ¨ä¸è§‚å¯Ÿ}</span>
                </div>
              )}
            </div>
          </div>
        </section>
      )}

      <!-- å¯Ÿè§‰ä¸æ´å¯Ÿ -->
      <section class="detail-section">
        <h3 class="section-title">ğŸ’¡ å¯Ÿè§‰ä¸æ´å¯Ÿ</h3>
        <div class="section-content">
          <div class="insight-details">
            <div class="detail-item">
              <strong>æ„Ÿå—ï¼š</strong>
              <span class="feeling-text">{record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ„Ÿå—}</span>
            </div>
            <div class="detail-item">
              <strong>æ´å¯Ÿï¼š</strong>
              <div class="insight-content">
                {record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ}
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- æ˜æ—¥è®¡åˆ’ -->
      {record.æ˜æ—¥è®¡åˆ’ && (
        <section class="detail-section">
          <h3 class="section-title">ğŸ¯ æ˜æ—¥è®¡åˆ’</h3>
          <div class="section-content">
            <p class="plan-content">{record.æ˜æ—¥è®¡åˆ’}</p>
          </div>
        </section>
      )}

      <!-- é…å›¾ -->
      {record.image_url && (
        <section class="detail-section">
          <h3 class="section-title">ğŸ–¼ï¸ é…å›¾</h3>
          <div class="section-content">
            <img 
              src={record.image_url} 
              alt="è¡Œæ€å½•é…å›¾"
              class="detail-image"
              loading="lazy"
            />
          </div>
        </section>
      )}
    </div>

    <!-- æ¨¡æ€æ¡†åº•éƒ¨ -->
    <footer class="modal-footer">
      {record.flomo_link && (
        <a href={record.flomo_link} class="flomo-link" target="_blank" rel="noopener">
          ğŸ“± æŸ¥çœ‹åŸæ–‡
        </a>
      )}
      <button class="close-btn-secondary" onclick={`toggleDetail('${cardId}')`}>
        å…³é—­
      </button>
    </footer>
  </div>
</div>

<style>
  /* å¡ç‰‡ä¸»ä½“æ ·å¼ - æ›´ç´§å‡‘ */
  .xingsi-card {
    @apply bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all duration-300;
    @apply border border-gray-200 dark:border-gray-700 cursor-pointer;
    @apply transform hover:-translate-y-1 hover:scale-105;
    @apply p-3; /* å‡å°‘å†…è¾¹è· */
  }

  /* å¡ç‰‡å¤´éƒ¨ */
  .card-header {
    @apply flex justify-between items-center mb-2;
  }

  .date-section {
    @apply flex flex-col;
  }

  .date-text {
    @apply text-sm font-medium text-gray-700 dark:text-gray-300;
  }

  .time-text {
    @apply text-xs text-gray-500 dark:text-gray-400;
  }

  .mood-section {
    @apply flex items-center;
  }

  .mood-icon {
    @apply text-lg;
  }

  /* ä¸»é¢˜æ ‡ç­¾ */
  .theme-row {
    @apply mb-2;
  }

  .theme-tag {
    @apply text-xs px-2 py-1 rounded-full font-medium;
  }

  /* å†…å®¹é¢„è§ˆ - æ›´ç´§å‡‘ */
  .content-preview {
    @apply space-y-2 mb-3;
  }

  .summary-text {
    @apply text-sm text-gray-700 dark:text-gray-300 leading-relaxed;
    @apply line-clamp-2; /* é™åˆ¶ä¸º2è¡Œ */
  }

  .insight-preview {
    @apply flex items-start gap-1 p-2 bg-blue-50 dark:bg-blue-900/20 rounded;
  }

  .insight-label {
    @apply text-sm flex-shrink-0;
  }

  .insight-text {
    @apply text-xs text-gray-600 dark:text-gray-400 italic;
    @apply line-clamp-2; /* é™åˆ¶ä¸º2è¡Œ */
  }

  /* å±•å¼€æŒ‰é’® */
  .expand-button {
    @apply w-full flex justify-between items-center p-2 text-sm;
    @apply text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300;
    @apply bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/30;
    @apply rounded transition-colors;
  }

  .expand-text {
    @apply font-medium;
  }

  .expand-icon {
    @apply text-xs transition-transform duration-200;
  }

  .expand-button:hover .expand-icon {
    @apply transform rotate-180;
  }

  /* æ¨¡æ€æ¡†æ ·å¼ */
  .detail-modal {
    @apply fixed inset-0 z-50 flex items-center justify-center p-4;
  }

  .modal-overlay {
    @apply absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm;
  }

  .modal-content {
    @apply relative bg-white dark:bg-gray-800 rounded-lg shadow-xl;
    @apply w-full max-w-4xl max-h-[90vh] overflow-hidden;
    @apply border border-gray-200 dark:border-gray-700;
  }

  /* æ¨¡æ€æ¡†å¤´éƒ¨ */
  .modal-header {
    @apply flex justify-between items-start p-4 border-b border-gray-200 dark:border-gray-700;
    @apply bg-gray-50 dark:bg-gray-750;
  }

  .modal-title {
    @apply text-lg font-semibold text-gray-900 dark:text-white;
  }

  .modal-date {
    @apply text-sm text-gray-600 dark:text-gray-400;
  }

  .close-btn {
    @apply text-gray-400 hover:text-gray-600 dark:hover:text-gray-300;
    @apply text-xl font-bold cursor-pointer;
  }

  /* æ¨¡æ€æ¡†å†…å®¹ */
  .modal-body {
    @apply p-4 overflow-y-auto max-h-[calc(90vh-120px)];
    @apply space-y-6;
  }

  .detail-section {
    @apply border-b border-gray-100 dark:border-gray-700 pb-4 last:border-b-0;
  }

  .section-title {
    @apply text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3;
  }

  .section-content {
    @apply space-y-3;
  }

  .subsection-title {
    @apply text-base font-medium text-purple-700 dark:text-purple-300;
    @apply bg-purple-50 dark:bg-purple-900/20 p-2 rounded;
  }

  .details-grid {
    @apply space-y-2;
  }

  .detail-item {
    @apply flex flex-col sm:flex-row sm:items-start gap-1 sm:gap-2;
  }

  .detail-item strong {
    @apply text-gray-700 dark:text-gray-300 min-w-24;
  }

  .detail-item span {
    @apply text-gray-600 dark:text-gray-400;
  }

  .text-content {
    @apply text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line;
  }

  .feeling-text {
    @apply text-orange-600 dark:text-orange-400 font-medium;
  }

  .insight-content {
    @apply text-gray-700 dark:text-gray-300 leading-relaxed;
    @apply bg-blue-50 dark:bg-blue-900/20 p-3 rounded border-l-4 border-blue-400;
    @apply italic;
  }

  .plan-content {
    @apply text-gray-700 dark:text-gray-300 leading-relaxed;
    @apply bg-green-50 dark:bg-green-900/20 p-3 rounded;
  }

  .detail-image {
    @apply w-full max-w-md mx-auto rounded-lg shadow-md;
  }

  /* æ¨¡æ€æ¡†åº•éƒ¨ */
  .modal-footer {
    @apply flex justify-between items-center p-4 border-t border-gray-200 dark:border-gray-700;
    @apply bg-gray-50 dark:bg-gray-750;
  }

  .flomo-link {
    @apply text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300;
    @apply text-sm transition-colors;
  }

  .close-btn-secondary {
    @apply px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded;
    @apply transition-colors;
  }

  /* éšè—ç±» */
  .hidden {
    @apply invisible opacity-0 pointer-events-none;
  }

  /* è¡Œæˆªæ–­ */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* å“åº”å¼ */
  @media (max-width: 640px) {
    .modal-content {
      @apply max-w-full m-2;
    }
    
    .detail-item {
      @apply flex-col;
    }
    
    .modal-footer {
      @apply flex-col gap-2;
    }
  }
</style>

<script>
  // åˆ‡æ¢è¯¦æƒ…æ˜¾ç¤ºçš„å…¨å±€å‡½æ•°
  window.toggleDetail = function(cardId: string) {
    const modal = document.getElementById(`detail-${cardId}`);
    if (modal) {
      modal.classList.toggle('hidden');
      
      // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
      if (!modal.classList.contains('hidden')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }
  };

  // ESCé”®å…³é—­æ¨¡æ€æ¡†
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const openModals = document.querySelectorAll('.detail-modal:not(.hidden)');
      openModals.forEach(modal => {
        modal.classList.add('hidden');
      });
      document.body.style.overflow = '';
    }
  });
</script>