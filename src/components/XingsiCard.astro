---
import type { XingsiRecord } from "@/types/xingsi";

export interface Props {
  record: XingsiRecord;
}

const { record } = Astro.props;

// è§£ææ—¥æœŸ
const date = new Date(record.datetime);
const formattedDate = date.toLocaleDateString('zh-CN', {
  month: 'long',
  day: 'numeric'
});
const formattedTime = date.toLocaleTimeString('zh-CN', {
  hour: '2-digit',
  minute: '2-digit'
});

// æå–ä»Šæ—¥å°è®¡çš„æ‘˜è¦ï¼ˆå‰80å­—ç¬¦ï¼‰
const getSummary = (text: string) => {
  const cleanText = text.replace(/\*\*/g, '').replace(/\n+/g, ' ').trim();
  return cleanText.length > 80 ? cleanText.substring(0, 80) + '...' : cleanText;
};

// è·å–å¿ƒæƒ…å›¾æ ‡
const getMoodIcon = (feeling: string) => {
  if (feeling.includes('å¹³é™') || feeling.includes('è‡ªåœ¨')) return 'ğŸ˜Œ';
  if (feeling.includes('ç–²æƒ«') || feeling.includes('ç´¯')) return 'ğŸ˜´';
  if (feeling.includes('å¤±æœ›') || feeling.includes('æ²®ä¸§')) return 'ğŸ˜';
  if (feeling.includes('ç„¦è™‘') || feeling.includes('çƒ¦èº')) return 'ğŸ˜°';
  if (feeling.includes('æ»¡è¶³') || feeling.includes('å¼€å¿ƒ')) return 'ğŸ˜Š';
  if (feeling.includes('å›°æƒ‘') || feeling.includes('è¿·èŒ«')) return 'ğŸ¤”';
  return 'ğŸ™‚';
};

// ç”Ÿæˆå”¯ä¸€ID
const cardId = `card-${record.datetime.replace(/[^0-9]/g, '')}`;
---

<article class="xingsi-card" data-id={cardId}>
  <!-- å¡ç‰‡å¤´éƒ¨ -->
  <header class="card-header">
    <div class="date-section">
      <time class="date-text">{formattedDate}</time>
      <span class="time-text">{formattedTime}</span>
    </div>
    <div class="mood-section">
      <span class="mood-icon">{getMoodIcon(record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ„Ÿå—)}</span>
    </div>
  </header>

  <!-- ä¸»é¢˜æ ‡ç­¾ -->
  {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.æœ¬å‘¨ä¸»é¢˜ && (
    <div class="theme-row">
      <span class="theme-tag">
        {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.æœ¬å‘¨ä¸»é¢˜}
      </span>
    </div>
  )}

  <!-- å†…å®¹é¢„è§ˆ -->
  <div class="content-preview">
    <p class="summary-text">
      {getSummary(record.ä»Šæ—¥å°è®¡)}
    </p>
    
    {record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ && (
      <div class="insight-preview">
        <span class="insight-label">ğŸ’¡</span>
        <span class="insight-text">
          {record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ.length > 60 
            ? record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ.substring(0, 60) + '...'
            : record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ
          }
        </span>
      </div>
    )}
  </div>

  <!-- ç‚¹å‡»å±•å¼€æŒ‰é’® -->
  <button class="expand-button" onclick={`toggleDetail('${cardId}')`}>
    <span class="expand-text">æŸ¥çœ‹è¯¦æƒ…</span>
    <span class="expand-icon">â–¼</span>
  </button>
</article>

<!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id={`detail-${cardId}`} class="detail-modal hidden">
  <div class="modal-overlay" onclick={`toggleDetail('${cardId}')`}></div>
  <div class="modal-content">
    <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
    <header class="modal-header">
      <div>
        <h2 class="modal-title">è¡Œæ€å½•è¯¦æƒ…</h2>
        <p class="modal-date">{formattedDate} {formattedTime}</p>
      </div>
      <button class="close-btn" onclick={`toggleDetail('${cardId}')`}>âœ•</button>
    </header>

    <!-- æ¨¡æ€æ¡†å†…å®¹ -->
    <div class="modal-body">
      <!-- ä»Šæ—¥å°è®¡ -->
      <section class="detail-section">
        <h3 class="section-title">ğŸ“ ä»Šæ—¥å°è®¡</h3>
        <div class="section-content">
          <p class="text-content" set:html={record.ä»Šæ—¥å°è®¡.replace(/\*\*/g, '').replace(/\n/g, '<br>')}></p>
        </div>
      </section>

      <!-- ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜ -->
      {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.title && (
        <section class="detail-section">
          <h3 class="section-title">ğŸ”„ ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜</h3>
          <div class="section-content">
            <h4 class="subsection-title">"{record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.title}"</h4>
            <div class="details-grid">
              <div class="detail-item">
                <strong>æœ¬å‘¨ä¸»é¢˜ï¼š</strong>
                <span>{record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.æœ¬å‘¨ä¸»é¢˜}</span>
              </div>
              {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.ä»Šæ—¥å®éªŒ && (
                <div class="detail-item">
                  <strong>ä»Šæ—¥å®éªŒï¼š</strong>
                  <span>{record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.ä»Šæ—¥å®éªŒ}</span>
                </div>
              )}
              {record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.è¡ŒåŠ¨ä¸è§‚å¯Ÿ && (
                <div class="detail-item">
                  <strong>è¡ŒåŠ¨ä¸è§‚å¯Ÿï¼š</strong>
                  <span>{record.ä¸»é¢˜è¡ŒåŠ¨å¤ç›˜.details.è¡ŒåŠ¨ä¸è§‚å¯Ÿ}</span>
                </div>
              )}
            </div>
          </div>
        </section>
      )}

      <!-- å¯Ÿè§‰ä¸æ´å¯Ÿ -->
      <section class="detail-section">
        <h3 class="section-title">ğŸ’¡ å¯Ÿè§‰ä¸æ´å¯Ÿ</h3>
        <div class="section-content">
          <div class="insight-details">
            <div class="detail-item">
              <strong>æ„Ÿå—ï¼š</strong>
              <span class="feeling-text">{record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ„Ÿå—}</span>
            </div>
            <div class="detail-item">
              <strong>æ´å¯Ÿï¼š</strong>
              <div class="insight-content">
                {record.å¯Ÿè§‰ä¸æ´å¯Ÿ.æ´å¯Ÿ}
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- æ˜æ—¥è®¡åˆ’ -->
      {record.æ˜æ—¥è®¡åˆ’ && (
        <section class="detail-section">
          <h3 class="section-title">ğŸ¯ æ˜æ—¥è®¡åˆ’</h3>
          <div class="section-content">
            <p class="plan-content">{record.æ˜æ—¥è®¡åˆ’}</p>
          </div>
        </section>
      )}

      <!-- é…å›¾ -->
      {record.image_url && (
        <section class="detail-section">
          <h3 class="section-title">ğŸ–¼ï¸ é…å›¾</h3>
          <div class="section-content">
            <img 
              src={record.image_url} 
              alt="è¡Œæ€å½•é…å›¾"
              class="detail-image"
              loading="lazy"
            />
          </div>
        </section>
      )}
    </div>

    <!-- æ¨¡æ€æ¡†åº•éƒ¨ -->
    <footer class="modal-footer">
      {record.flomo_link && (
        <a href={record.flomo_link} class="flomo-link" target="_blank" rel="noopener">
          ğŸ“± æŸ¥çœ‹åŸæ–‡
        </a>
      )}
      <button class="close-btn-secondary" onclick={`toggleDetail('${cardId}')`}>
        å…³é—­
      </button>
    </footer>
  </div>
</div>

<style>
  /* å¡ç‰‡ä¸»ä½“æ ·å¼ - æ›´ç´§å‡‘ */
  .xingsi-card {
    background: rgb(var(--color-fill));
    border: 1px solid rgb(var(--color-border));
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    padding: 0.75rem;
  }

  .xingsi-card:hover {
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    transform: translateY(-0.25rem) scale(1.02);
  }

  /* å¡ç‰‡å¤´éƒ¨ */
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .date-section {
    display: flex;
    flex-direction: column;
  }

  .date-text {
    font-size: 0.875rem;
    font-weight: 500;
    color: rgb(var(--color-text-base));
  }

  .time-text {
    font-size: 0.75rem;
    color: rgb(var(--color-text-muted));
  }

  .mood-section {
    display: flex;
    align-items: center;
  }

  .mood-icon {
    font-size: 1.125rem;
  }

  /* ä¸»é¢˜æ ‡ç­¾ */
  .theme-row {
    margin-bottom: 0.5rem;
  }

  .theme-tag {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-weight: 500;
    background: rgb(var(--color-accent) / 0.1);
    color: rgb(var(--color-accent));
  }

  /* å†…å®¹é¢„è§ˆ - æ›´ç´§å‡‘ */
  .content-preview {
    margin-bottom: 0.75rem;
  }

  .content-preview > * {
    margin-bottom: 0.5rem;
  }

  .content-preview > *:last-child {
    margin-bottom: 0;
  }

  .summary-text {
    font-size: 0.875rem;
    color: rgb(var(--color-text-base));
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .insight-preview {
    display: flex;
    align-items: flex-start;
    gap: 0.25rem;
    padding: 0.5rem;
    background: rgb(var(--color-accent) / 0.05);
    border-radius: 0.375rem;
  }

  .insight-label {
    font-size: 0.875rem;
    flex-shrink: 0;
  }

  .insight-text {
    font-size: 0.75rem;
    color: rgb(var(--color-text-muted));
    font-style: italic;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* å±•å¼€æŒ‰é’® */
  .expand-button {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    font-size: 0.875rem;
    color: rgb(var(--color-accent));
    background: rgb(var(--color-accent) / 0.05);
    border: none;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .expand-button:hover {
    background: rgb(var(--color-accent) / 0.1);
  }

  .expand-text {
    font-weight: 500;
  }

  .expand-icon {
    font-size: 0.75rem;
    transition: transform 0.2s ease;
  }

  .expand-button:hover .expand-icon {
    transform: rotate(180deg);
  }

  /* æ¨¡æ€æ¡†æ ·å¼ */
  .detail-modal {
    position: fixed;
    inset: 0;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    position: relative;
    background: rgb(var(--color-fill));
    border-radius: 0.5rem;
    box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
    width: 100%;
    max-width: 56rem;
    max-height: 90vh;
    overflow: hidden;
    border: 1px solid rgb(var(--color-border));
  }

  /* æ¨¡æ€æ¡†å¤´éƒ¨ */
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1rem;
    border-bottom: 1px solid rgb(var(--color-border));
    background: rgb(var(--color-card-muted));
  }

  .modal-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: rgb(var(--color-text-base));
  }

  .modal-date {
    font-size: 0.875rem;
    color: rgb(var(--color-text-muted));
  }

  .close-btn {
    color: rgb(var(--color-text-muted));
    font-size: 1.25rem;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0.25rem;
  }

  .close-btn:hover {
    color: rgb(var(--color-text-base));
  }

  /* æ¨¡æ€æ¡†å†…å®¹ */
  .modal-body {
    padding: 1rem;
    overflow-y: auto;
    max-height: calc(90vh - 120px);
  }

  .modal-body > * {
    margin-bottom: 1.5rem;
  }

  .modal-body > *:last-child {
    margin-bottom: 0;
  }

  .detail-section {
    border-bottom: 1px solid rgb(var(--color-border));
    padding-bottom: 1rem;
  }

  .detail-section:last-child {
    border-bottom: none;
  }

  .section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: rgb(var(--color-text-base));
    margin-bottom: 0.75rem;
  }

  .section-content > * {
    margin-bottom: 0.75rem;
  }

  .section-content > *:last-child {
    margin-bottom: 0;
  }

  .subsection-title {
    font-size: 1rem;
    font-weight: 500;
    color: rgb(var(--color-accent));
    background: rgb(var(--color-accent) / 0.1);
    padding: 0.5rem;
    border-radius: 0.375rem;
  }

  .details-grid > * {
    margin-bottom: 0.5rem;
  }

  .details-grid > *:last-child {
    margin-bottom: 0;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .detail-item strong {
    color: rgb(var(--color-text-base));
    min-width: 6rem;
  }

  .detail-item span {
    color: rgb(var(--color-text-muted));
  }

  .text-content {
    color: rgb(var(--color-text-base));
    line-height: 1.6;
    white-space: pre-line;
  }

  .feeling-text {
    color: rgb(var(--color-accent));
    font-weight: 500;
  }

  .insight-content {
    color: rgb(var(--color-text-base));
    line-height: 1.6;
    background: rgb(var(--color-accent) / 0.1);
    padding: 0.75rem;
    border-radius: 0.375rem;
    border-left: 4px solid rgb(var(--color-accent));
    font-style: italic;
  }

  .plan-content {
    color: rgb(var(--color-text-base));
    line-height: 1.6;
    background: rgb(var(--color-card-muted));
    padding: 0.75rem;
    border-radius: 0.375rem;
  }

  .detail-image {
    width: 100%;
    max-width: 28rem;
    margin: 0 auto;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  }

  /* æ¨¡æ€æ¡†åº•éƒ¨ */
  .modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-top: 1px solid rgb(var(--color-border));
    background: rgb(var(--color-card-muted));
  }

  .flomo-link {
    color: rgb(var(--color-accent));
    font-size: 0.875rem;
    transition: color 0.2s ease;
    text-decoration: none;
  }

  .flomo-link:hover {
    color: rgb(var(--color-accent));
    opacity: 0.8;
  }

  .close-btn-secondary {
    padding: 0.5rem 1rem;
    background: rgb(var(--color-text-muted));
    color: white;
    border: none;
    border-radius: 0.375rem;
    transition: background 0.2s ease;
    cursor: pointer;
  }

  .close-btn-secondary:hover {
    background: rgb(var(--color-text-base));
  }

  /* éšè—ç±» */
  .hidden {
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
  }

  /* å“åº”å¼ */
  @media (max-width: 640px) {
    .modal-content {
      max-width: 100%;
      margin: 0.5rem;
    }
    
    .detail-item {
      flex-direction: column;
    }
    
    .modal-footer {
      flex-direction: column;
      gap: 0.5rem;
    }
  }

  @media (min-width: 640px) {
    .detail-item {
      flex-direction: row;
      align-items: flex-start;
      gap: 0.5rem;
    }
  }
</style>

<script>
  // åˆ‡æ¢è¯¦æƒ…æ˜¾ç¤ºçš„å…¨å±€å‡½æ•°
  (window as any).toggleDetail = function(cardId: string) {
    const modal = document.getElementById(`detail-${cardId}`);
    if (modal) {
      modal.classList.toggle('hidden');
      
      // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
      if (!modal.classList.contains('hidden')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }
  };

  // ESCé”®å…³é—­æ¨¡æ€æ¡†
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const openModals = document.querySelectorAll('.detail-modal:not(.hidden)');
      openModals.forEach(modal => {
        modal.classList.add('hidden');
      });
      document.body.style.overflow = '';
    }
  });
</script>