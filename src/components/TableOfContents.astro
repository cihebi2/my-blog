---
// TableOfContents.astro - åŠ¨æ€ç›®å½•ç»„ä»¶
---

<!-- ç§»åŠ¨ç«¯ç›®å½•æŒ‰é’® -->
<button
  id="toc-mobile-toggle"
  class="toc-mobile-button"
  title="æ˜¾ç¤º/éšè—ç›®å½•"
>
  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
    <path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z"/>
  </svg>
</button>

<!-- ç§»åŠ¨ç«¯ç›®å½•é¢æ¿ -->
<div
  id="toc-mobile-panel"
  class="toc-mobile-panel"
>
  <div class="toc-mobile-header">
    <h3 class="toc-mobile-title">ç›®å½•</h3>
    <button
      id="toc-mobile-close"
      class="toc-mobile-close"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
      </svg>
    </button>
  </div>
  <ul id="toc-mobile-list" class="toc-mobile-list">
    <!-- ç§»åŠ¨ç«¯ç›®å½•å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
  </ul>
</div>

<!-- æ¡Œé¢ç«¯ç›®å½• -->
<aside
  id="table-of-contents"
  class="toc-container"
>
  <nav class="toc-nav">
    <h3 class="toc-title">ç›®å½•</h3>
    <ul id="toc-list" class="toc-list">
      <!-- ç›®å½•å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
    </ul>
  </nav>
</aside>

<style>
  /* æ¡Œé¢ç«¯ç›®å½•å®¹å™¨ */
  .toc-container {
    position: fixed;
    left: 2rem;
    top: 50%;
    transform: translateY(-50%);
    width: 16rem;
    max-height: 75vh;
    overflow-y: auto;
    display: none;
    z-index: 30;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }
  
  /* æ”¶èµ·çŠ¶æ€ */
  .toc-container.collapsed {
    left: -14rem;
    opacity: 0.9;
    visibility: visible;
    pointer-events: auto;
  }
  
  /* ç§»é™¤æ‚¬åœå±•å¼€åŠŸèƒ½ï¼Œé¿å…å¹²æ‰°é˜…è¯» */
  
  /* å±•å¼€çŠ¶æ€ */
  .toc-container.visible {
    opacity: 1;
    visibility: visible;
    left: 2rem;
    pointer-events: auto;
  }
  
  /* æ”¶èµ·æ—¶çš„æç¤ºæ ‡ç­¾ */
  .toc-container.collapsed::after {
    content: 'ğŸ“‹';
    position: absolute;
    right: -3rem;
    top: 50%;
    transform: translateY(-50%);
    width: 2.5rem;
    height: 2.5rem;
    background: rgba(var(--color-card), 0.95);
    border: 1px solid rgba(var(--color-accent), 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    z-index: 35;
  }
  
  .toc-container.collapsed::after:hover {
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    cursor: pointer;
  }
  
  /* å±å¹•å®½åº¦æ£€æµ‹ */
  @media (min-width: 1024px) and (max-width: 1679px) {
    .toc-container {
      display: block;
      /* ä¸­ç­‰å±å¹•é»˜è®¤æ”¶èµ· */
    }
  }
  
  @media (min-width: 1680px) {
    .toc-container {
      display: block;
      /* å¤§å±å¹•è‡ªåŠ¨å±•å¼€ */
    }
  }
  
  .toc-nav {
    border-radius: 0.75rem;
    border: 1px solid rgba(var(--color-accent), 0.2);
    background: linear-gradient(145deg, 
      rgba(var(--color-card), 0.95) 0%, 
      rgba(var(--color-card), 0.9) 100%);
    padding: 1.25rem;
    box-shadow: 
      0 20px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px) saturate(180%);
    scrollbar-width: thin;
    scrollbar-color: rgba(var(--color-accent), 0.3) transparent;
    position: relative;
    overflow: hidden;
  }
  
  .toc-nav::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
      rgba(var(--color-accent), 0.5) 0%, 
      rgba(var(--color-accent), 0.8) 50%, 
      rgba(var(--color-accent), 0.5) 100%);
    border-radius: 0.75rem 0.75rem 0 0;
  }
  
  .toc-title {
    margin-bottom: 1rem;
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--color-accent);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: relative;
  }
  
  .toc-title::after {
    content: '';
    position: absolute;
    bottom: -0.25rem;
    left: 0;
    width: 2rem;
    height: 2px;
    background: rgba(var(--color-accent), 0.6);
    border-radius: 1px;
  }
  
  .toc-list {
    font-size: 0.875rem;
  }
  
  .toc-list li {
    margin-bottom: 0.25rem;
  }
  
  /* ç§»åŠ¨ç«¯ç›®å½•æŒ‰é’® */
  .toc-mobile-button {
    position: fixed;
    bottom: 5rem;
    right: 1rem;
    z-index: 50;
    border-radius: 50%;
    background-color: var(--color-accent);
    padding: 0.75rem;
    color: var(--color-background);
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    transition: transform 0.2s ease-in-out;
    border: none;
    cursor: pointer;
  }
  
  .toc-mobile-button:hover {
    transform: scale(1.1);
  }
  
  @media (min-width: 1024px) {
    .toc-mobile-button {
      display: none;
    }
  }
  
  /* ç§»åŠ¨ç«¯ç›®å½•é¢æ¿ */
  .toc-mobile-panel {
    position: fixed;
    left: 1rem;
    right: 1rem;
    top: 5rem;
    z-index: 40;
    border-radius: 0.5rem;
    border: 1px solid var(--color-border);
    background-color: rgb(from var(--color-background) r g b / 0.95);
    padding: 1rem;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    backdrop-filter: blur(8px);
    display: none;
  }
  
  .toc-mobile-panel.hidden {
    display: none;
  }
  
  @media (min-width: 1024px) {
    .toc-mobile-panel {
      display: none !important;
    }
  }
  
  .toc-mobile-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }
  
  .toc-mobile-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-foreground);
  }
  
  .toc-mobile-close {
    color: rgb(from var(--color-foreground) r g b / 0.5);
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.2s ease-in-out;
  }
  
  .toc-mobile-close:hover {
    color: var(--color-foreground);
  }
  
  .toc-mobile-list {
    font-size: 0.875rem;
    max-height: 15rem;
    overflow-y: auto;
  }
  
  .toc-mobile-list li {
    margin-bottom: 0.25rem;
  }
  
  .toc-link {
    display: block;
    padding: 0.5rem 0.75rem;
    margin: 0.25rem 0;
    color: rgba(var(--color-base), 0.8);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    border-left: 3px solid transparent;
    border-radius: 0 0.375rem 0.375rem 0;
    position: relative;
    overflow: hidden;
    line-height: 1.4;
  }
  
  .toc-link::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 100%;
    background: linear-gradient(90deg, 
      rgba(var(--color-accent), 0.1) 0%, 
      rgba(var(--color-accent), 0.05) 100%);
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: -1;
  }
  
  .toc-link:hover {
    color: var(--color-accent);
    transform: translateX(4px);
    border-left-color: rgba(var(--color-accent), 0.5);
  }
  
  .toc-link:hover::before {
    width: 100%;
  }
  
  .toc-link.active {
    color: var(--color-accent);
    border-left-color: var(--color-accent);
    font-weight: 600;
    background: linear-gradient(90deg, 
      rgba(var(--color-accent), 0.15) 0%, 
      rgba(var(--color-accent), 0.05) 100%);
    transform: translateX(6px);
    box-shadow: 0 2px 4px rgba(var(--color-accent), 0.2);
  }
  
  .toc-link.active::before {
    width: 100%;
    background: linear-gradient(90deg, 
      rgba(var(--color-accent), 0.2) 0%, 
      rgba(var(--color-accent), 0.1) 100%);
  }
  
  .toc-link.h1 {
    font-size: 0.9rem;
    font-weight: 600;
    margin: 0.5rem 0;
  }
  
  .toc-link.h2 {
    font-size: 0.85rem;
    margin-left: 0.5rem;
  }
  
  .toc-link.h3 {
    font-size: 0.8rem;
    margin-left: 1rem;
    opacity: 0.9;
  }
  
  .toc-link.h4 {
    font-size: 0.75rem;
    margin-left: 1.5rem;
    opacity: 0.8;
  }
  
  .toc-link.h5,
  .toc-link.h6 {
    font-size: 0.7rem;
    margin-left: 2rem;
    opacity: 0.7;
  }
</style>

<script is:inline data-astro-rerun>
  // å…¨å±€çŠ¶æ€å˜é‡
  let isManuallyExpanded = false;
  let isManuallyCollapsed = false;

  function generateTableOfContents() {
    const tocContainer = document.getElementById('table-of-contents');
    const tocList = document.getElementById('toc-list');
    const tocMobileList = document.getElementById('toc-mobile-list');
    const tocMobileToggle = document.getElementById('toc-mobile-toggle');
    const article = document.getElementById('article');
    
    if (!article) return;
    
    // è·å–æ‰€æœ‰æ ‡é¢˜å…ƒç´ 
    const headings = article.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    if (headings.length === 0) {
      if (tocContainer) tocContainer.style.display = 'none';
      if (tocMobileToggle) tocMobileToggle.style.display = 'none';
      return;
    }
    
    // æ˜¾ç¤ºç›®å½•å®¹å™¨å¹¶æ ¹æ®å±å¹•å®½åº¦è®¾ç½®çŠ¶æ€
    if (tocContainer) {
      tocContainer.style.display = 'block';
      setTimeout(() => {
        updateTocVisibilityByScreenSize();
      }, 100);
    }
    
    // ç”Ÿæˆç›®å½•é¡¹çš„å‡½æ•°
    function createTocItems(targetList) {
      if (!targetList) return;
      
      targetList.innerHTML = '';
      
      headings.forEach((heading, index) => {
        if (!heading.id) {
          heading.id = `heading-${index}`;
        }
        
        const li = document.createElement('li');
        const a = document.createElement('a');
        
        a.href = `#${heading.id}`;
        a.textContent = heading.textContent?.replace('#', '').trim() || '';
        a.className = `toc-link ${heading.tagName.toLowerCase()}`;
        
        li.appendChild(a);
        targetList.appendChild(li);
      });
    }
    
    // ä¸ºæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯éƒ½ç”Ÿæˆç›®å½•
    createTocItems(tocList);
    createTocItems(tocMobileList);
    
    // æ·»åŠ æ»šåŠ¨ç›‘å¬ï¼Œé«˜äº®å½“å‰ç« èŠ‚
    setupScrollSpy();
    
    // è®¾ç½®ç§»åŠ¨ç«¯ç›®å½•åŠŸèƒ½
    setupMobileToc();
    
    // è®¾ç½®æ™ºèƒ½æ˜¾ç¤ºæ§åˆ¶
    setupSmartVisibility();
  }
  
  // æ™ºèƒ½æ˜¾ç¤ºæ§åˆ¶
  function updateTocVisibilityByScreenSize() {
    const tocContainer = document.getElementById('table-of-contents');
    if (!tocContainer) return;
    
    const screenWidth = window.innerWidth;
    
    if (screenWidth >= 1680) {
      // å¤§å±å¹•ï¼šè‡ªåŠ¨å±•å¼€ï¼ˆç§»é™¤collapsedï¼Œæ·»åŠ visibleï¼‰
      tocContainer.classList.remove('collapsed');
      tocContainer.classList.add('visible');
    } else if (screenWidth >= 1024) {
      // ä¸­ç­‰å±å¹•ï¼šåªæœ‰åœ¨æ²¡æœ‰æ‰‹åŠ¨æ“ä½œæ—¶æ‰è®¾ç½®é»˜è®¤çŠ¶æ€
      if (!isManuallyExpanded && !isManuallyCollapsed) {
        tocContainer.classList.remove('visible');
        tocContainer.classList.add('collapsed');
      }
    } else {
      // å°å±å¹•ï¼šå®Œå…¨éšè—ï¼Œä½¿ç”¨ç§»åŠ¨ç«¯æŒ‰é’®
      tocContainer.classList.remove('visible', 'collapsed');
    }
  }
  
  function setupSmartVisibility() {
    const tocContainer = document.getElementById('table-of-contents');
    if (!tocContainer) return;
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    let resizeTimer = null;
    window.addEventListener('resize', () => {
      if (resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        updateTocVisibilityByScreenSize();
      }, 150);
    });
    
    // æ·»åŠ ç‚¹å‡»åˆ‡æ¢åŠŸèƒ½ï¼ˆç”¨äºä¸­ç­‰å±å¹•ï¼‰
    
    tocContainer.addEventListener('click', (_e) => {
      const screenWidth = window.innerWidth;
      
      // åªåœ¨ä¸­ç­‰å±å¹•å¯ç”¨ç‚¹å‡»åˆ‡æ¢
      if (screenWidth >= 1024 && screenWidth < 1680) {
        if (tocContainer.classList.contains('collapsed')) {
          tocContainer.classList.remove('collapsed');
          tocContainer.classList.add('visible');
          isManuallyExpanded = true;
          isManuallyCollapsed = false;
        } else if (isManuallyExpanded) {
          tocContainer.classList.remove('visible');
          tocContainer.classList.add('collapsed');
          isManuallyExpanded = false;
          isManuallyCollapsed = true;
        }
      }
    });
    
    // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸæ”¶èµ·ï¼ˆä»…ä¸­ç­‰å±å¹•æ‰‹åŠ¨å±•å¼€æ—¶ï¼‰
    document.addEventListener('click', (e) => {
      const screenWidth = window.innerWidth;
      
      if (screenWidth >= 1024 && screenWidth < 1680 && isManuallyExpanded) {
        if (!tocContainer.contains(e.target)) {
          tocContainer.classList.remove('visible');
          tocContainer.classList.add('collapsed');
          isManuallyExpanded = false;
          isManuallyCollapsed = true;
        }
      }
    });
    
    // åˆå§‹è®¾ç½®
    updateTocVisibilityByScreenSize();
  }
  
  function setupScrollSpy() {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('#article h1, #article h2, #article h3, #article h4, #article h5, #article h6');
    
    if (tocLinks.length === 0 || headings.length === 0) return;
    
    let activeSection = null;
    
    // æ£€æŸ¥æ–‡ç« åº•éƒ¨å¹¶æ§åˆ¶ç›®å½•æ˜¾ç¤ºï¼ˆä»…åœ¨å¤§å±å¹•è‡ªåŠ¨å±•å¼€æ—¶ç”Ÿæ•ˆï¼‰
    function checkArticleVisibility() {
      const article = document.getElementById('article');
      const tocContainer = document.getElementById('table-of-contents');
      
      if (!article || !tocContainer) return;
      
      const screenWidth = window.innerWidth;
      
      // åªåœ¨å¤§å±å¹•ï¼ˆ1680px+ï¼‰è‡ªåŠ¨æ§åˆ¶ç›®å½•æ˜¾ç¤ºï¼Œä¸­ç­‰å±å¹•ä¸è‡ªåŠ¨æ§åˆ¶
      if (screenWidth >= 1680) {
        const articleRect = article.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        
        // å¦‚æœæ–‡ç« åº•éƒ¨è¶…å‡ºè§†çª—åº•éƒ¨ï¼Œéšè—ç›®å½•
        if (articleRect.bottom < windowHeight * 0.3) {
          tocContainer.classList.remove('visible');
        } else {
          tocContainer.classList.add('visible');
        }
      }
    }
    
    // æ›´ç²¾ç¡®çš„æ»šåŠ¨ç›‘å¬
    const observer = new IntersectionObserver(
      (entries) => {
        // æ‰¾åˆ°å½“å‰å¯è§çš„æœ€ä¸Šé¢çš„æ ‡é¢˜
        let topEntry = null;
        let topY = Infinity;
        
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const rect = entry.boundingRect;
            if (rect.top >= 0 && rect.top < topY) {
              topY = rect.top;
              topEntry = entry;
            }
          }
        });
        
        if (topEntry && topEntry.target.id !== activeSection) {
          activeSection = topEntry.target.id;
          updateActiveLink(activeSection);
        }
      },
      {
        rootMargin: '-20% 0px -70% 0px',
        threshold: [0, 0.25, 0.5, 0.75, 1]
      }
    );
    
    // ç›‘å¬æ»šåŠ¨äº‹ä»¶æ¥æ§åˆ¶ç›®å½•æ˜¾ç¤º
    let scrollTimer = null;
    window.addEventListener('scroll', () => {
      if (scrollTimer) clearTimeout(scrollTimer);
      scrollTimer = setTimeout(checkArticleVisibility, 50);
    });
    
    // æ›´æ–°æ¿€æ´»é“¾æ¥çš„å‡½æ•°
    function updateActiveLink(activeId) {
      // ç§»é™¤æ‰€æœ‰activeç±»
      document.querySelectorAll('.toc-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // æ·»åŠ activeç±»åˆ°å½“å‰é“¾æ¥
      const activeLinks = document.querySelectorAll(`.toc-link[href="#${activeId}"]`);
      activeLinks.forEach(link => {
        if (link) {
          link.classList.add('active');
          
          // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸï¼ˆä»…æ¡Œé¢ç«¯ç›®å½•ï¼‰
          const tocContainer = document.getElementById('table-of-contents');
          if (tocContainer && tocContainer.contains(link)) {
            const tocNav = tocContainer.querySelector('.toc-nav');
            if (tocNav) {
              const linkRect = link.getBoundingClientRect();
              const navRect = tocNav.getBoundingClientRect();
              
              if (linkRect.top < navRect.top || linkRect.bottom > navRect.bottom) {
                link.scrollIntoView({
                  behavior: 'smooth',
                  block: 'center'
                });
              }
            }
          }
        }
      });
    }
    
    headings.forEach((heading) => {
      observer.observe(heading);
    });
    
    // åˆå§‹æ£€æŸ¥æ–‡ç« å¯è§æ€§
    checkArticleVisibility();
    
    // ç‚¹å‡»ç›®å½•é“¾æ¥æ—¶å¹³æ»‘æ»šåŠ¨
    const allTocLinks = document.querySelectorAll('.toc-link');
    allTocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        
        const targetId = link.getAttribute('href')?.substring(1);
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          // ç«‹å³æ›´æ–°æ´»è·ƒçŠ¶æ€
          updateActiveLink(targetId);
          
          // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
          
          // å¹³æ»‘æ»šåŠ¨å®Œæˆ
          
          // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œå…³é—­ç›®å½•é¢æ¿
          const mobilePanel = document.getElementById('toc-mobile-panel');
          if (mobilePanel && mobilePanel.style.display === 'block') {
            mobilePanel.style.display = 'none';
          }
        }
      });
    });
  }
  
  function setupMobileToc() {
    const mobileToggle = document.getElementById('toc-mobile-toggle');
    const mobilePanel = document.getElementById('toc-mobile-panel');
    const mobileClose = document.getElementById('toc-mobile-close');
    
    if (!mobileToggle || !mobilePanel || !mobileClose) return;
    
    // åˆ‡æ¢ç§»åŠ¨ç«¯ç›®å½•é¢æ¿
    mobileToggle.addEventListener('click', () => {
      if (mobilePanel.style.display === 'none' || mobilePanel.style.display === '') {
        mobilePanel.style.display = 'block';
      } else {
        mobilePanel.style.display = 'none';
      }
    });
    
    // å…³é—­ç§»åŠ¨ç«¯ç›®å½•é¢æ¿
    mobileClose.addEventListener('click', () => {
      mobilePanel.style.display = 'none';
    });
    
    // ç‚¹å‡»é¢æ¿å¤–éƒ¨å…³é—­
    document.addEventListener('click', (e) => {
      if (!mobilePanel.contains(e.target) && !mobileToggle.contains(e.target)) {
        mobilePanel.style.display = 'none';
      }
    });
  }
  
  // é¡µé¢åŠ è½½åç”Ÿæˆç›®å½•
  document.addEventListener('DOMContentLoaded', generateTableOfContents);
  
  // Astro page transition åé‡æ–°ç”Ÿæˆç›®å½•
  document.addEventListener('astro:after-swap', generateTableOfContents);
</script> 